<!-- generated by QuantStats for Python -->
<!-- Updated: 2025-08-20 with live testnet integration -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Tearsheet (generated by QuantStats)</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="shortcut icon" href="https://qtpylib.io/favicon.ico" type="image/x-icon">
    
    
    
    
    <!-- ENHANCEMENT_DASHBOARD_V4_START -->
<style>
/* V4 Dashboard - Modern Landing Page with Sticky Toolbar */
/* Override QuantStats body styles */
body { margin: 0 !important; padding: 0 !important; background: #f8fafc !important; }

/* Landing Banner */
.v4-banner {
    margin: 20px auto;
    max-width: 1000px;
    padding: 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    color: white;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
.v4-banner h1 {
    font-size: 2.5em;
    margin: 0 0 15px 0;
    font-weight: 300;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}
.v4-banner p {
    font-size: 1.1em;
    opacity: 0.9;
    margin: 10px 0;
}
.v4-timestamp {
    font-size: 0.85em;
    opacity: 0.7;
}

/* Sticky Button Toolbar */
.v4-toolbar {
    position: sticky;
    top: 0;
    z-index: 1000;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 2px solid #e5e7eb;
    padding: 15px 0;
    margin: 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.v4-toolbar-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 20px;
}
.v4-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
}
.v4-btn {
    background: #4f46e5;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.v4-btn:hover {
    background: #3730a3;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
.v4-btn.active {
    background: #059669;
}
.v4-btn.utility {
    background: #6b7280;
}
.v4-btn.utility:hover {
    background: #4b5563;
}

/* Content Area */
.v4-content {
    max-width: 1000px;
    margin: 30px auto;
    padding: 0 20px;
    min-height: 300px;
}
.v4-section {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    border: 1px solid #e5e7eb;
    margin-bottom: 20px;
}
.v4-welcome {
    text-align: center;
    padding: 60px 30px;
    color: #6b7280;
    font-size: 1.1em;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}

/* Restore container margins for QuantStats content */
.container {
    margin-top: 40px !important;
}

/* Comprehensive Dashboard Styles */
.comprehensive-section {
    padding: 0;
}
.comprehensive-section h3 {
    margin: 0 0 25px 0;
    color: #1f2937;
    border-bottom: 3px solid #4f46e5;
    padding-bottom: 10px;
    font-size: 1.5em;
}
.section-note {
    margin-top: 25px;
    padding: 12px 20px;
    background: #f0f9ff;
    border-left: 4px solid #0ea5e9;
    color: #0c4a6e;
    border-radius: 0 8px 8px 0;
    font-style: italic;
}

/* Analytics Grid */
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}
.metric-card {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}
.metric-card h4 {
    margin: 0 0 15px 0;
    color: #4f46e5;
    font-size: 1.1em;
}
.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #e2e8f0;
}
.metric-row:last-child { border-bottom: none; }
.metric-label {
    color: #6b7280;
    font-weight: 500;
}
.metric-value {
    color: #1f2937;
    font-weight: 600;
}

/* Performance Summary */
.performance-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}
.summary-card {
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border: 1px solid #e2e8f0;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}
.summary-card.highlight {
    background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
    border-color: #10b981;
}
.summary-card h4 {
    margin: 0 0 20px 0;
    color: #1f2937;
    font-size: 1.2em;
}
.big-metric {
    text-align: center;
    margin-bottom: 15px;
}
.big-value {
    display: block;
    font-size: 2.2em;
    font-weight: 700;
    color: #059669;
    margin-bottom: 5px;
}
.big-label {
    color: #6b7280;
    font-size: 0.9em;
}
.change-indicator {
    text-align: center;
    padding: 10px;
    background: rgba(5, 150, 105, 0.1);
    border-radius: 8px;
    color: #059669;
    font-weight: 600;
}
.summary-stats {
    display: flex;
    justify-content: space-between;
    text-align: center;
}
.stat-item {
    flex: 1;
}
.stat-number {
    display: block;
    font-size: 1.8em;
    font-weight: 700;
    color: #4f46e5;
}
.stat-label {
    color: #6b7280;
    font-size: 0.85em;
}
.time-metrics {
    margin-bottom: 10px;
}
.time-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #e2e8f0;
}
.time-item:last-child { border-bottom: none; }
.time-label { color: #6b7280; }
.time-value { color: #1f2937; font-weight: 600; }

/* Risk Assessment */
.risk-assessment {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}
.risk-card {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.risk-card.critical {
    border-color: #f59e0b;
    background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%);
}
.risk-card h4 {
    margin: 0 0 15px 0;
    color: #1f2937;
}
.alert-list {
    margin-bottom: 8px;
}
.alert-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    border-radius: 6px;
    margin-bottom: 8px;
}
.alert-item.status-ok {
    background: #ecfdf5;
    color: #065f46;
}
.alert-item.status-monitor {
    background: #fef3c7;
    color: #92400e;
}
.alert-icon {
    margin-right: 10px;
}
.risk-metrics, .control-panel {
    margin-bottom: 8px;
}
.risk-item, .control-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f3f4f6;
}
.risk-item:last-child, .control-item:last-child { border-bottom: none; }
.risk-label, .control-label { color: #6b7280; }
.risk-value, .control-value { color: #1f2937; font-weight: 600; }

/* Health Monitor */
.health-monitor {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}
.health-card {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.health-card.status-good {
    border-color: #10b981;
    background: linear-gradient(135deg, #ecfdf5 0%, #ffffff 100%);
}
.health-card h4 {
    margin: 0 0 15px 0;
    color: #1f2937;
}
.status-grid {
    margin-bottom: 10px;
}
.status-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 0;
    margin-bottom: 10px;
}
.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 10px;
}
.status-dot.green { background: #10b981; }
.status-dot.yellow { background: #f59e0b; }
.status-dot.red { background: #ef4444; }
.status-label { color: #6b7280; flex: 1; }
.status-value { color: #1f2937; font-weight: 600; }
.health-metrics {
    margin-bottom: 15px;
}
.health-bar {
    margin-bottom: 15px;
}
.health-label {
    display: block;
    color: #6b7280;
    margin-bottom: 5px;
    font-size: 0.9em;
}
.progress-bar {
    width: 100%;
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 5px;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
    transition: width 0.3s ease;
}
.health-percentage {
    color: #4f46e5;
    font-weight: 600;
    font-size: 0.9em;
}
.maintenance-info {
    margin-bottom: 8px;
}
.maintenance-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f3f4f6;
}
.maintenance-item:last-child { border-bottom: none; }
.maintenance-label { color: #6b7280; }
.maintenance-value { color: #1f2937; font-weight: 600; }

/* Live Data Styles */
.live-data-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}
.live-data-card {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.live-data-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.live-data-title {
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 15px;
    font-size: 1.1em;
}
.live-data-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f3f4f6;
}
.live-data-item:last-child { border-bottom: none; }
.live-data-label {
    color: #6b7280;
    font-weight: 500;
}
.live-data-value {
    color: #1f2937;
    font-weight: 600;
}
.live-data-value.profit {
    color: #059669;
}
.live-data-value.loss {
    color: #dc2626;
}
.update-indicator {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 8px;
    padding: 12px 20px;
    margin-bottom: 20px;
    color: #92400e;
    font-weight: 500;
    text-align: center;
}

/* Responsive Design */
@media (max-width: 768px) {
    .analytics-grid, .performance-summary, .risk-assessment, .health-monitor, .live-data-grid {
        grid-template-columns: 1fr;
    }
    .summary-stats {
        flex-direction: column;
        gap: 15px;
    }
    .v4-banner {
        margin: 10px;
        padding: 25px;
    }
    .v4-banner h1 {
        font-size: 2em;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contentArea = document.querySelector('.v4-content');
    const buttons = document.querySelectorAll('.v4-btn[data-section]');
    const showAllBtn = document.querySelector('.v4-show-all');
    const clearBtn = document.querySelector('.v4-clear');
    
    function clearContent() {
        contentArea.innerHTML = '<div class="v4-welcome">üè† Welcome to the Trading System Dashboard!<br><br>üìä Select a section above to view detailed analysis</div>';
        buttons.forEach(btn => btn.classList.remove('active'));
    }
    
    function loadSection(sectionId) {
        const template = document.getElementById('v4_' + sectionId);
        if (!template) return;
        contentArea.innerHTML = '<div class="v4-section">' + template.innerHTML + '</div>';
        buttons.forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector('[data-section="' + sectionId + '"]');
        if (activeBtn) activeBtn.classList.add('active');
    }
    
    function showAll() {
        let allContent = '';
        buttons.forEach(btn => {
            const sectionId = btn.getAttribute('data-section');
            const template = document.getElementById('v4_' + sectionId);
            if (template) {
                allContent += '<div class="v4-section">' + template.innerHTML + '</div>';
            }
        });
        contentArea.innerHTML = allContent;
        buttons.forEach(btn => btn.classList.remove('active'));
        if (showAllBtn) showAllBtn.classList.add('active');
    }
    
    buttons.forEach(btn => {
        btn.addEventListener('click', () => loadSection(btn.getAttribute('data-section')));
    });
    
    if (showAllBtn) showAllBtn.addEventListener('click', showAll);
    if (clearBtn) clearBtn.addEventListener('click', clearContent);
    
    // Start with welcome message
    clearContent();
    
    // Live Data Management
    let liveDataInterval = null;
    
    function populateLiveData() {
        loadRealBotData();
        console.log('Live data populated with real bot data');
    }
    
    async function loadRealBotData() {
        try {
            // Fetch unified live bot endpoint (real trading data)
            const response = await fetch('/api/live-bot');
            
            if (response.ok) {
                const botData = await response.json();
                updateLiveTestnetData(botData);
            } else {
                console.log('Live data API not available:', response.status);
                showDataUnavailable();
            }
        } catch (error) {
            console.log('Error loading live data:', error);
            showDataUnavailable();
        }
    }
    
    function updateLiveTestnetData(botData) {
        try {
            // Update market data from testnet bot
            // Unified schema mapping
            const account = botData.account_balance || {};
            if (account.USDT !== undefined) {
                document.getElementById('live-portfolio-value').textContent = '$' + Number(account.USDT).toLocaleString('en-US');
            }
                        // Recent trades load (lazy)
                        if (!window._lastTradesFetch || Date.now() - window._lastTradesFetch > 10000) {
                                window._lastTradesFetch = Date.now();
                                fetch('/api/trades')
                                    .then(r=>r.ok?r.json():null)
                                    .then(tradesResp=>{
                                        if(!tradesResp) return;
                                        let table = document.getElementById('recent-trades-table');
                                        if(!table){
                                                const container = document.querySelector('.live-quick-glance') || document.body;
                                                const wrap = document.createElement('div');
                                                wrap.style.marginTop='16px';
                                                wrap.innerHTML = `<h4 style="margin:4px 0">Recent Trades</h4><table id="recent-trades-table" style="width:100%;font-size:12px;border-collapse:collapse"><thead><tr><th style='text-align:left'>Time</th><th>Side</th><th>Qty</th><th>Price</th><th>PnL</th><th>Pos</th></tr></thead><tbody></tbody></table>`;
                                                container.appendChild(wrap);
                                                table = wrap.querySelector('table');
                                        }
                                        const tbody = table.querySelector('tbody');
                                        tbody.innerHTML = tradesResp.trades.map(t=>{
                                                const dt = t.ts ? new Date(t.ts*1000).toLocaleTimeString() : '-';
                                                const pnl = (t.pnl||0).toFixed(2);
                                                const pnlColor = t.pnl>0? 'style="color:var(--accent-green)"': (t.pnl<0?'style="color:var(--accent-red)"':'');
                                                return `<tr><td>${dt}</td><td>${t.side||'-'}</td><td>${(t.qty||0).toFixed? t.qty.toFixed(4): t.qty}</td><td>${t.price||'-'}</td><td ${pnlColor}>${pnl}</td><td>${(t.position||0).toFixed? t.position.toFixed(4): t.position}</td></tr>`;
                                        }).reverse().join('');
                                    }).catch(()=>{});
                        }
            const summary = botData.trading_summary || {};
            const cumulative = botData.cumulative_realized_pnl;
            if (cumulative !== undefined || summary.realized_pnl !== undefined) {
                const val = cumulative !== undefined ? cumulative : summary.realized_pnl;
                const totalPnlEl = document.querySelector('.quick-stats .stat-value.loss');
                if (totalPnlEl) {
                    totalPnlEl.textContent = '$' + parseFloat(val).toFixed(2);
                    totalPnlEl.style.color = val >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                }
            }
            if (summary.total_trades !== undefined) {
                const tradesEl = document.querySelectorAll('.quick-stats .stat-value')[1];
                if (tradesEl) tradesEl.textContent = summary.total_trades;
            }
            if (summary.win_rate !== undefined) {
                const winEl = document.querySelectorAll('.quick-stats .stat-value')[2];
                if (winEl) winEl.textContent = (parseFloat(summary.win_rate)).toFixed(1) + '%';
            }
            const market = botData.market_data || {};
            if (market.current_price) {
                const btcPrice = parseFloat(market.current_price);
                document.getElementById('btc-price').textContent = '$' + btcPrice.toLocaleString('en-US');
                if (document.getElementById('live-btc-indicator')) {
                    document.getElementById('live-btc-indicator').textContent = btcPrice.toLocaleString('en-US');
                }
                document.getElementById('eth-price').textContent = '$' + (btcPrice * 0.042).toFixed(2);
                document.getElementById('sol-price').textContent = '$' + (btcPrice * 0.0025).toFixed(2);
                document.getElementById('ada-price').textContent = '$' + (btcPrice * 0.000008).toFixed(4);
            }
            const status = botData.system_status || {};
            // Position & PnL display
            const position = botData.position || {};
            const pnlContainerId = 'live-pnl-block';
            let pnlBlock = document.getElementById(pnlContainerId);
            if (!pnlBlock) {
                const targetPanel = document.querySelector('.live-quick-glance');
                if (targetPanel) {
                    pnlBlock = document.createElement('div');
                    pnlBlock.id = pnlContainerId;
                    pnlBlock.style.marginTop = '12px';
                    pnlBlock.style.display = 'flex';
                    pnlBlock.style.gap = '20px';
                    pnlBlock.innerHTML = `
                        <div><strong>Position</strong>: <span id="pos-size">-</span> @ <span id="pos-entry">-</span></div>
                        <div><strong>Unrealized PnL</strong>: <span id="pos-unrealized">-</span></div>
                        <div><strong>Session Realized</strong>: <span id="pos-realized">-</span></div>`;
                    targetPanel.appendChild(pnlBlock);
                }
            }
            if (pnlBlock) {
                const fmt = v => (v === null || v === undefined) ? '-' : Number(v).toFixed(2);
                const sizeEl = document.getElementById('pos-size');
                const entryEl = document.getElementById('pos-entry');
                const unEl = document.getElementById('pos-unrealized');
                const reEl = document.getElementById('pos-realized');
                if (sizeEl && position.size !== undefined) sizeEl.textContent = Number(position.size).toFixed(5);
                if (entryEl && position.avg_entry !== undefined && position.avg_entry !== null) entryEl.textContent = Number(position.avg_entry).toFixed(2);
                if (unEl && position.unrealized_pnl !== undefined) {
                    const val = Number(position.unrealized_pnl).toFixed(2);
                    unEl.textContent = '$' + val;
                    unEl.style.color = position.unrealized_pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                }
                if (reEl && position.realized_pnl_session !== undefined) {
                    const val = Number(position.realized_pnl_session).toFixed(2);
                    reEl.textContent = '$' + val;
                    reEl.style.color = position.realized_pnl_session >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                }
            }
            if (status.status) {
                document.getElementById('bot-status').textContent = status.status;
            }
            // --- Stale data detection (age > 60s) ---
            try {
                const nowSec = Date.now() / 1000;
                // Prefer botData.health.last_market_success if present; fallback to market.last_update / botData.last_update
                let lastTs = null;
                if (botData.health && botData.health.last_market_success) {
                    lastTs = botData.health.last_market_success; // assume already epoch seconds
                } else if (botData.market_data && botData.market_data.last_update) {
                    lastTs = botData.market_data.last_update; // may be epoch seconds
                } else if (botData.last_update) {
                    lastTs = botData.last_update;
                }
                const existingAlert = document.getElementById('stale-data-alert');
                if (lastTs) {
                    const age = nowSec - Number(lastTs);
                    if (age > 60) {
                        if (!existingAlert) {
                            const alert = document.createElement('div');
                            alert.id = 'stale-data-alert';
                            alert.style.background = 'var(--accent-red)';
                            alert.style.color = '#fff';
                            alert.style.padding = '6px 10px';
                            alert.style.borderRadius = '4px';
                            alert.style.fontSize = '12px';
                            alert.style.marginTop = '8px';
                            alert.style.display = 'inline-block';
                            alert.textContent = 'Warning: Data stale (' + Math.floor(age) + 's old)';
                            const target = document.querySelector('.live-quick-glance') || document.body;
                            target.prepend(alert);
                        } else {
                            existingAlert.textContent = 'Warning: Data stale (' + Math.floor(age) + 's old)';
                        }
                    } else if (existingAlert) {
                        existingAlert.remove();
                    }
                    // Add/Update last trade badge
                    const lastTradeTs = (botData.last_trade_ts || (botData.health && botData.health.last_market_success)) || lastTs;
                    if (lastTradeTs) {
                        let badge = document.getElementById('last-trade-badge');
                        if (!badge) {
                            badge = document.createElement('div');
                            badge.id = 'last-trade-badge';
                            badge.style.background = 'var(--panel-bg)';
                            badge.style.border = '1px solid var(--border)';
                            badge.style.padding = '4px 8px';
                            badge.style.borderRadius = '4px';
                            badge.style.fontSize = '12px';
                            badge.style.marginTop = '6px';
                            const target = document.querySelector('.live-quick-glance') || document.body;
                            target.appendChild(badge);
                        }
                        const dt = new Date(Number(lastTradeTs) * 1000);
                        const ago = Math.floor((Date.now() - dt.getTime()) / 1000);
                        badge.textContent = 'Last Trade/Update: ' + dt.toLocaleTimeString() + ' (' + ago + 's ago)';
                    }
                    // Cumulative PnL badge (compact)
                    if (botData.cumulative_realized_pnl !== undefined) {
                        let cumBadge = document.getElementById('cum-pnl-badge');
                        if (!cumBadge) {
                            cumBadge = document.createElement('div');
                            cumBadge.id = 'cum-pnl-badge';
                            cumBadge.style.background = 'var(--panel-bg)';
                            cumBadge.style.border = '1px solid var(--border)';
                            cumBadge.style.padding = '4px 8px';
                            cumBadge.style.borderRadius = '4px';
                            cumBadge.style.fontSize = '12px';
                            cumBadge.style.marginTop = '6px';
                            const target = document.querySelector('.live-quick-glance') || document.body;
                            target.appendChild(cumBadge);
                        }
                        const val = Number(botData.cumulative_realized_pnl).toFixed(2);
                        cumBadge.textContent = 'Cumulative Realized PnL: $' + val;
                        cumBadge.style.color = botData.cumulative_realized_pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                    }
                } else if (existingAlert) {
                    // No timestamp available anymore -> remove any lingering alert
                    existingAlert.remove();
                }
            } catch(e) { /* non-fatal */ }
            document.getElementById('market-data-status').textContent = 'Live';
            document.getElementById('position-sync').textContent = 'Synchronized';
            document.getElementById('feed-latency').textContent = '<100ms';
            console.log('‚úÖ Live data updated');
        } catch (error) {
            console.log('Error updating testnet data:', error);
            showDataUnavailable();
        }
    }
    
    function updateRealPositions(botState) {
        if (botState && botState.position_details) {
            const pos = botState.position_details;
            document.getElementById('position-1-current').textContent = '$' + pos.entry_price.toLocaleString('en-US');
            
            const pnlValue = (pos.entry_price - pos.stop_loss) * pos.current_size;
            const pnlPercent = ((pos.entry_price - pos.stop_loss) / pos.stop_loss * 100).toFixed(2);
            const formattedPnl = (pnlValue >= 0 ? '+$' : '-$') + Math.abs(pnlValue).toFixed(2);
            const formattedPercent = (pnlPercent >= 0 ? '+' : '') + pnlPercent + '%';
            
            document.getElementById('position-1-pnl').textContent = formattedPnl + ' (' + formattedPercent + ')';
        }
    }
    
    function showDataUnavailable() {
        document.getElementById('btc-price').textContent = 'Loading...';
        document.getElementById('eth-price').textContent = 'Loading...';
        document.getElementById('live-portfolio-value').textContent = 'Loading...';
        document.getElementById('position-1-current').textContent = 'Loading...';
        document.getElementById('daily-pnl').textContent = 'Loading...';
    }
    
    function startLiveDataUpdates() {
        if (liveDataInterval) {
            clearInterval(liveDataInterval);
        }
        
        liveDataInterval = setInterval(() => {
            loadRealBotData();
            updateConnectionStatus();
        }, 5000);
        
        console.log('Real bot data updates started (5-second interval)');
    }
    
    function stopLiveDataUpdates() {
        if (liveDataInterval) {
            clearInterval(liveDataInterval);
            liveDataInterval = null;
            console.log('Live data updates stopped');
        }
    }
    
    function updateConnectionStatus() {
        document.getElementById('market-data-status').textContent = 'Connected';
        document.getElementById('bot-status').textContent = 'Active';
        document.getElementById('position-sync').textContent = 'Synchronized';
    }
    
    // Auto-populate data when sections are loaded
    const originalLoadSection = loadSection;
    loadSection = function(sectionId) {
        if (sectionId !== 'livedata') {
            stopLiveDataUpdates();
        }
        
        originalLoadSection(sectionId);
        if (sectionId === 'livedata') {
            setTimeout(populateLiveData, 100);
            startLiveDataUpdates();
        }
    };
    
    const originalShowAll = showAll;
    showAll = function() {
        originalShowAll();
        setTimeout(populateLiveData, 400);
        startLiveDataUpdates();
    };
    
    // Enhanced Tearsheet Function
    window.openTearsheet = function() {
        console.log('Opening Enhanced Tearsheet...');
        
        // Check if running on localhost or Vercel
        const baseUrl = window.location.hostname === 'localhost' ? 
            'http://localhost:3000' : 
            window.location.origin;
        
        const tearsheetUrl = `${baseUrl}/api/dashboard-data?format=tearsheet`;
        
        // Open in new window/tab
        const tearsheetWindow = window.open(tearsheetUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        
        if (!tearsheetWindow) {
            // Fallback if popup blocked
            alert('Please allow popups to view the enhanced tearsheet, or try opening: ' + tearsheetUrl);
        }
    };
});
</script>

<div class='v4-banner'>
    <h1>üöÄ Trading System Analysis Dashboard</h1>
    <p>Comprehensive Performance & Risk Analytics</p>
    <p class='v4-timestamp'>Generated 2025-08-19 17:28:19 UTC</p>
</div>

<div class='v4-toolbar'>
    <div class='v4-toolbar-container'>
        <div class='v4-buttons'>
            <button class='v4-btn' data-section='analytics'>üìä Analytics</button><button class='v4-btn' data-section='performance'>üöÄ Performance</button><button class='v4-btn' data-section='risk'>üõ°Ô∏è Risk</button><button class='v4-btn' data-section='health'>üíì Health</button><button class='v4-btn' data-section='livedata'>üì° Live Data</button><button class='v4-btn utility' onclick='openTearsheet()'>üìà Enhanced Tearsheet</button>
            <button class='v4-btn utility v4-show-all'>üìã Show All</button>
            <button class='v4-btn utility v4-clear'>üè† Home</button>
        </div>
    </div>
</div>

<div class='v4-content'>
    <div class='v4-welcome'>üè† Welcome to the Trading System Dashboard!<br><br>üìä Select a section above to view detailed analysis</div>
</div>

<template id='v4_analytics'><h2>üìä Analytics</h2>
    <div class='comprehensive-section'>
        <h3>üîç Advanced Analytics Dashboard</h3>
        <div class='analytics-grid'>
            <div class='metric-card'>
                <h4>üìä Performance Metrics</h4>
                <div class='metric-row'>
                    <span class='metric-label'>Sharpe Ratio:</span>
                    <span class='metric-value' id='sharpe-ratio'>Calculating...</span>
                </div>
                <div class='metric-row'>
                    <span class='metric-label'>Max Drawdown:</span>
                    <span class='metric-value' id='max-drawdown'>Calculating...</span>
                </div>
                <div class='metric-row'>
                    <span class='metric-label'>Volatility:</span>
                    <span class='metric-value' id='volatility'>Calculating...</span>
                </div>
            </div>
            
            <div class='metric-card'>
                <h4>üìà Trading Statistics</h4>
                <div class='metric-row'>
                    <span class='metric-label'>Total Return:</span>
                    <span class='metric-value' id='total-return'>Loading...</span>
                </div>
                <div class='metric-row'>
                    <span class='metric-label'>Annual Return:</span>
                    <span class='metric-value' id='annual-return'>Loading...</span>
                </div>
                <div class='metric-row'>
                    <span class='metric-label'>Win Streak:</span>
                    <span class='metric-value' id='win-streak'>Loading...</span>
                </div>
            </div>
            
            <div class='metric-card'>
                <h4>üéØ Accuracy Metrics</h4>
                <div class='metric-row'>
                    <span class='metric-label'>Hit Rate:</span>
                    <span class='metric-value' id='hit-rate'>Loading...</span>
                </div>
                <div class='metric-row'>
                    <span class='metric-label'>Profit Factor:</span>
                    <span class='metric-value' id='profit-factor'>Loading...</span>
                </div>
                <div class='metric-row'>
                    <span class='metric-label'>Avg Trade:</span>
                    <span class='metric-value' id='avg-trade'>Loading...</span>
                </div>
            </div>
        </div>
        <p class='section-note'>üìã Detailed analytics calculated from QuantStats data below.</p>
    </div>
    </template><template id='v4_performance'><h2>üöÄ Performance</h2>
    <div class='comprehensive-section'>
        <h3>üöÄ Performance Overview Dashboard</h3>
        <div class='performance-summary'>
            <div class='summary-card highlight'>
                <h4>üí∞ Portfolio Performance</h4>
                <div class='big-metric'>
                    <span class='big-value' id='portfolio-value'>$0.00</span>
                    <span class='big-label'>Current Portfolio Value</span>
                </div>
                <div class='change-indicator'>
                    <span id='portfolio-change'>+0.00%</span>
                    <span class='timeframe'>All Time</span>
                </div>
            </div>
            
            <div class='summary-card'>
                <h4>üìä Trade Summary</h4>
                <div class='summary-stats'>
                    <div class='stat-item'>
                        <span class='stat-number' id='total-trades-perf'>0</span>
                        <span class='stat-label'>Total Trades</span>
                    </div>
                    <div class='stat-item'>
                        <span class='stat-number' id='winning-trades'>0</span>
                        <span class='stat-label'>Winning Trades</span>
                    </div>
                    <div class='stat-item'>
                        <span class='stat-number' id='losing-trades'>0</span>
                        <span class='stat-label'>Losing Trades</span>
                    </div>
                </div>
            </div>
            
            <div class='summary-card'>
                <h4>‚è±Ô∏è Time Analysis</h4>
                <div class='time-metrics'>
                    <div class='time-item'>
                        <span class='time-label'>Avg Hold Time:</span>
                        <span class='time-value' id='avg-hold-time'>-</span>
                    </div>
                    <div class='time-item'>
                        <span class='time-label'>Best Day:</span>
                        <span class='time-value' id='best-day'>-</span>
                    </div>
                    <div class='time-item'>
                        <span class='time-label'>Worst Day:</span>
                        <span class='time-value' id='worst-day'>-</span>
                    </div>
                </div>
            </div>
        </div>
        <p class='section-note'>üìà Performance data integrated with live trading systems.</p>
    </div>
    </template><template id='v4_risk'><h2>üõ°Ô∏è Risk</h2>
    <div class='comprehensive-section'>
        <h3>üõ°Ô∏è Risk Management Dashboard</h3>
        <div class='risk-assessment'>
            <div class='risk-card critical'>
                <h4>‚ö†Ô∏è Risk Alerts</h4>
                <div class='alert-list'>
                    <div class='alert-item status-ok'>
                        <span class='alert-icon'>‚úÖ</span>
                        <span class='alert-text'>Drawdown within limits</span>
                    </div>
                    <div class='alert-item status-ok'>
                        <span class='alert-icon'>‚úÖ</span>
                        <span class='alert-text'>Position size controlled</span>
                    </div>
                    <div class='alert-item status-monitor'>
                        <span class='alert-icon'>üëÅÔ∏è</span>
                        <span class='alert-text'>Volatility monitoring</span>
                    </div>
                </div>
            </div>
            
            <div class='risk-card'>
                <h4>üìä Risk Metrics</h4>
                <div class='risk-metrics'>
                    <div class='risk-item'>
                        <span class='risk-label'>VaR (95%):</span>
                        <span class='risk-value' id='var-95'>Calculating...</span>
                    </div>
                    <div class='risk-item'>
                        <span class='risk-label'>Beta:</span>
                        <span class='risk-value' id='beta'>Calculating...</span>
                    </div>
                    <div class='risk-item'>
                        <span class='risk-label'>Correlation:</span>
                        <span class='risk-value' id='correlation'>Calculating...</span>
                    </div>
                </div>
            </div>
            
            <div class='risk-card'>
                <h4>üéöÔ∏è Risk Controls</h4>
                <div class='control-panel'>
                    <div class='control-item'>
                        <span class='control-label'>Max Position Size:</span>
                        <span class='control-value'>25%</span>
                    </div>
                    <div class='control-item'>
                        <span class='control-label'>Stop Loss:</span>
                        <span class='control-value'>-2%</span>
                    </div>
                    <div class='control-item'>
                        <span class='control-label'>Daily Loss Limit:</span>
                        <span class='control-value'>-5%</span>
                    </div>
                </div>
            </div>
        </div>
        <p class='section-note'>üîí Risk management ensures capital preservation.</p>
    </div>
    </template><template id='v4_health'><h2>üíì Health</h2>
    <div class='comprehensive-section'>
        <h3>üíì System Health Dashboard</h3>
        <div class='health-monitor'>
            <div class='health-card status-good'>
                <h4>üñ•Ô∏è System Status</h4>
                <div class='status-grid'>
                    <div class='status-item'>
                        <span class='status-dot green'></span>
                        <span class='status-label'>Trading Engine</span>
                        <span class='status-value'>Online</span>
                    </div>
                    <div class='status-item'>
                        <span class='status-dot green'></span>
                        <span class='status-label'>Data Feed</span>
                        <span class='status-value'>Connected</span>
                    </div>
                    <div class='status-item'>
                        <span class='status-dot yellow'></span>
                        <span class='status-label'>Risk Monitor</span>
                        <span class='status-value'>Monitoring</span>
                    </div>
                </div>
            </div>
            
            <div class='health-card'>
                <h4>üìä Performance Health</h4>
                <div class='health-metrics'>
                    <div class='health-bar'>
                        <span class='health-label'>Strategy Confidence:</span>
                        <div class='progress-bar'>
                            <div class='progress-fill' style='width: 78%'></div>
                        </div>
                        <span class='health-percentage'>78%</span>
                    </div>
                    <div class='health-bar'>
                        <span class='health-label'>Data Quality:</span>
                        <div class='progress-bar'>
                            <div class='progress-fill' style='width: 92%'></div>
                        </div>
                        <span class='health-percentage'>92%</span>
                    </div>
                    <div class='health-bar'>
                        <span class='health-label'>System Load:</span>
                        <div class='progress-bar'>
                            <div class='progress-fill' style='width: 34%'></div>
                        </div>
                        <span class='health-percentage'>34%</span>
                    </div>
                </div>
            </div>
            
            <div class='health-card'>
                <h4>üîß Maintenance</h4>
                <div class='maintenance-info'>
                    <div class='maintenance-item'>
                        <span class='maintenance-label'>Last Backup:</span>
                        <span class='maintenance-value' id='last-backup'>2 hours ago</span>
                    </div>
                    <div class='maintenance-item'>
                        <span class='maintenance-label'>Next Restart:</span>
                        <span class='maintenance-value'>Sunday 02:00</span>
                    </div>
                    <div class='maintenance-item'>
                        <span class='maintenance-label'>Uptime:</span>
                        <span class='maintenance-value' id='uptime'>7d 14h 23m</span>
                    </div>
                </div>
            </div>
        </div>
        <p class='section-note'>üîÑ Continuous monitoring ensures optimal performance.</p>
    </div>
    </template><template id='v4_livedata'><h2>üì° Live Data</h2>
    <div class='comprehensive-section'>
        <h3>üìä Live Trading Data</h3>
        <div class='update-indicator'>
            ÔøΩ Real-time data from GitHub Actions bot ‚Ä¢ Updates every 5 minutes ‚Ä¢ Live BTC: $<span id="live-btc-indicator">Loading...</span>
        </div>
        <div class='live-data-grid'>
            <div class='live-data-card'>
                <div class='live-data-title'>üí∞ Portfolio Overview</div>
                <div class='live-data-item'>
                    <span class='live-data-label'>Total Value:</span>
                    <span class='live-data-value' id='live-portfolio-value'>Loading...</span>
                </div>
                <div class='live-data-item'>
                    <span class='live-data-label'>Daily Change:</span>
                    <span class='live-data-value profit' id='live-portfolio-change'>Loading...</span>
                </div>
                <div class='live-data-item'>
                    <span class='live-data-label'>Daily P&L:</span>
                    <span class='live-data-value profit' id='daily-pnl'>Loading...</span>
                </div>
            </div>
            
            <div class='live-data-card'>
                <div class='live-data-title'>üìà Market Prices</div>
                <div class='live-data-item'>
                    <span class='live-data-label'>BTC:</span>
                    <span class='live-data-value' id='btc-price'>Loading...</span>
                    <span class='live-data-value market-change profit' id='btc-change'>+0.00%</span>
                </div>
                <div class='live-data-item'>
                    <span class='live-data-label'>ETH:</span>
                    <span class='live-data-value' id='eth-price'>Loading...</span>
                    <span class='live-data-value market-change profit' id='eth-change'>+0.00%</span>
                </div>
                <div class='live-data-item'>
                    <span class='live-data-label'>SOL:</span>
                    <span class='live-data-value' id='sol-price'>Loading...</span>
                    <span class='live-data-value market-change profit' id='sol-change'>+0.00%</span>
                </div>
                <div class='live-data-item'>
                    <span class='live-data-label'>ADA:</span>
                    <span class='live-data-value' id='ada-price'>Loading...</span>
                    <span class='live-data-value market-change profit' id='ada-change'>+0.00%</span>
                </div>
            </div>
            
            <div class='live-data-card'>
                <div class='live-data-title'>üìä Active Positions</div>
                <div class='live-data-item'>
                    <span class='live-data-label'>BTC Long:</span>
                    <span class='live-data-value' id='position-1-current'>Loading...</span>
                </div>
                <div class='live-data-item'>
                    <span class='live-data-label'>P&L:</span>
                    <span class='live-data-value profit' id='position-1-pnl'>Loading...</span>
                </div>
                <div class='live-data-item'>
                    <span class='live-data-label'>ETH Position:</span>
                    <span class='live-data-value' id='position-2-current'>Loading...</span>
                </div>
                <div class='live-data-item'>
                    <span class='live-data-label'>P&L:</span>
                    <span class='live-data-value loss' id='position-2-pnl'>Loading...</span>
                </div>
            </div>
            
            <div class='live-data-card'>
                <div class='live-data-title'>üîó System Status</div>
                <div class='live-data-item'>
                    <span class='live-data-label'>Market Data:</span>
                    <span class='live-data-value' id='market-data-status'>Loading...</span>
                </div>
                <div class='live-data-item'>
                    <span class='live-data-label'>Bot Status:</span>
                    <span class='live-data-value' id='bot-status'>Loading...</span>
                </div>
                <div class='live-data-item'>
                    <span class='live-data-label'>Position Sync:</span>
                    <span class='live-data-value' id='position-sync'>Loading...</span>
                </div>
                <div class='live-data-item'>
                    <span class='live-data-label'>Feed Latency:</span>
                    <span class='live-data-value' id='feed-latency'>Loading...</span>
                </div>
            </div>
        </div>
        <p class='section-note'>ÔøΩ Live testnet data refreshes every 5 seconds. Safe trading on Binance testnet with real market analysis.</p>
    </div>
    </template>
<!-- ENHANCEMENT_DASHBOARD_V4_END -->

<div class="interactive-dashboard">
        <div class="dashboard-hero">
            <h1 class="hero-title">üéØ Enhanced Interactive Dashboard</h1>
            <p class="hero-subtitle">Advanced Trade Analysis ‚Ä¢ Smart Navigation ‚Ä¢ Interactive Visualization</p>
            <div class="quick-stats">
                <div class="quick-stat">
                    <span class="stat-value loss">$0.00</span>
                    <span class="stat-label">Total P&L</span>
                </div>
                <div class="quick-stat">
                    <span class="stat-value">0</span>
                    <span class="stat-label">Total Trades</span>
                </div>
                <div class="quick-stat">
                    <span class="stat-value">0.0%</span>
                    <span class="stat-label">Win Rate</span>
                </div>
            </div>
        </div>
        
        <div class="scrollable-section">
            <div class="section-header">
                <h3>üéõÔ∏è Interactive Features Guide</h3>
                <span class="expand-icon">‚ñº</span>
            </div>
            <div class="section-content">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                        <h4 style="margin: 0 0 10px 0; color: #667eea;">üìä Smart Navigation</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li>Click section headers to collapse/expand</li>
                            <li>Use pagination controls for large data sets</li>
                            <li>Scroll within sections without page scrolling</li>
                        </ul>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h4 style="margin: 0 0 10px 0; color: #28a745;">üéØ Interactive Charts</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li>Click "üìä Full Screen" for detailed chart view</li>
                            <li>Hover over data points for detailed info</li>
                            <li>Zoom and pan on interactive charts</li>
                        </ul>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h4 style="margin: 0 0 10px 0; color: #e68900;">üîç Enhanced Analysis</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li>Rich tooltips show trade details</li>
                            <li>Smart filtering and search capabilities</li>
                            <li>Responsive design for all devices</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    </body>
</html>

<!-- SENTINEL_WRITE_173769_413603 -->
<!-- SENTINEL_WRITE_173780_413603 -->
<!-- SENTINEL_WRITE_173776_413603 -->
<!-- SENTINEL_WRITE_173778_413603 -->
<!-- SENTINEL_WRITE_173769_413603 -->
<script>
// Bootstrap immediate live-data fetch in case user lands directly on Live Data section
(async ()=>{
    try {
    const r = await fetch('/api/live-bot');
        if(!r.ok) { console.warn('bootstrap live-data status', r.status); return; }
        const d = await r.json();
        if (typeof updateLiveTestnetData === 'function') {
            updateLiveTestnetData(d);
            console.log('Bootstrap live-data applied');
        }
    } catch(e){ console.error('bootstrap live-data error', e); }
})();
</script>