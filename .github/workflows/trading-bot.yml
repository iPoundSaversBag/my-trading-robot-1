# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Automated Trading Bot

on:
  schedule:
    # Run every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: trading-bot
  cancel-in-progress: true

jobs:
  trading-cycle:
    runs-on: ubuntu-latest
    timeout-minutes: 4
    steps:
      - name: Export required secrets
        shell: bash
        env:
          BOT_SECRET_SRC: ${{ secrets.BOT_SECRET }}
          VERCEL_URL_SRC: ${{ secrets.VERCEL_URL }}
        run: |
          set -euo pipefail
          if [ -z "${BOT_SECRET_SRC}" ] || [ -z "${VERCEL_URL_SRC}" ]; then
            echo "[WARN] Missing one or more required secrets (BOT_SECRET / VERCEL_URL)." >&2
            exit 1
          fi
          echo "BOT_SECRET=${BOT_SECRET_SRC}" >> "$GITHUB_ENV"
          echo "VERCEL_URL=${VERCEL_URL_SRC}" >> "$GITHUB_ENV"
          echo "Secrets exported (values masked)."
      - name: Execute Trading Cycle
        id: trade
        shell: bash
        run: |
          set -euo pipefail
          URL="${VERCEL_URL%/}/api/live-bot"
          echo "Calling $URL"
          RESP=$(curl -sS -H "Authorization: Bearer $BOT_SECRET" \
                        -H "Content-Type: application/json" \
                        --retry 3 --retry-delay 5 --max-time 30 \
                        -w "\n%{http_code}" "$URL" || true)
          BODY="$(echo "$RESP" | head -n -1 | head -c 400 | tr '\n' ' ')"
          CODE="$(echo "$RESP" | tail -n1)"
          echo "HTTP $CODE body(snippet)=$BODY"
          echo "code=$CODE" >> "$GITHUB_OUTPUT"
          echo "body_snippet=$BODY" >> "$GITHUB_OUTPUT"
          if [ "$CODE" != 200 ]; then
            echo "Live bot returned non-200 ($CODE)" >&2; exit 1; fi
      - name: Log Result
        run: echo "Trading cycle completed at $(date -u)"
      - name: Job Summary
        if: always()
        run: |
          status=${{ job.status }}
          code=${{ steps.trade.outputs.code || 'n/a' }}
          echo "### Trading Bot Run" >> "$GITHUB_STEP_SUMMARY"
          echo "Status: $status  " >> "$GITHUB_STEP_SUMMARY"
          echo "HTTP Code: $code  " >> "$GITHUB_STEP_SUMMARY"
          if [ "$status" != 'success' ]; then
            echo "Failure body snippet:" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "${{ steps.trade.outputs.body_snippet || 'no snippet' }}" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          fi
